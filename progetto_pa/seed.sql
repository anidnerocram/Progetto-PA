DROP DATABASE IF EXISTS dbpa;

DROP TABLE IF EXISTS position;
DROP TABLE IF EXISTS event;
DROP TABLE IF EXISTS users;
DROP TABLE IF EXISTS geofence_vehicle;
DROP TABLE IF EXISTS geofence;
DROP TABLE IF EXISTS vehicle;

CREATE DATABASE dbpa;
\c dbpa

CREATE EXTENSION postgis;

CREATE TABLE users(
    email VARCHAR(100),
    cf VARCHAR(100),
    name VARCHAR(100),
    surname VARCHAR(100),
    role VARCHAR(100),
    token FLOAT,
    PRIMARY KEY(email)
);

CREATE TABLE position(
    vehicle_license_plate VARCHAR(100),
    timestamp BIGINT,
    latitude FLOAT,
    longitude FLOAT,
    altitude FLOAT,
    speed FLOAT,
    point GEOMETRY,
    PRIMARY KEY(vehicle_license_plate, timestamp)  
);

CREATE TABLE event(
    license_plate VARCHAR(100),
    geofence_id VARCHAR(100),
    timestamp BIGINT,
    type VARCHAR(100),
    PRIMARY KEY(license_plate, timestamp, geofence_id)
);

CREATE TABLE geofence_vehicle(
    license_plate VARCHAR(100),
    geofence_id VARCHAR(100),
    PRIMARY KEY(license_plate, geofence_id)
);

CREATE TABLE geofence(
    id VARCHAR(100), 
    coordinates GEOMETRY,
    max_speed INT,
    PRIMARY KEY(id)
);

CREATE TABLE vehicle(
    license_plate VARCHAR(100),
    brand VARCHAR(100),
    model VARCHAR(100),
    owner_cf VARCHAR(100),
    PRIMARY KEY(license_plate)
);

INSERT INTO users (email, cf, name, surname, role, token) VALUES 
  ('marco@email.com', 'MRCRND97', 'Marco', 'Rendina', 'admin', 10),
  ('michele@email.com', 'MHLCVR97', 'Michele', 'Ciavarella', 'user', 10),
  ('dario@email.com', 'DROSSN97', 'Dario', 'Sassano', 'user', 10),
  ('antonio@email.com','NTNMNC96', 'Antonio', 'Monaco', 'user', 10);

INSERT INTO vehicle (license_plate, brand, model, owner_cf) VALUES 
  ('FP', 'Fiat', 'Panda', 'NTNMNC96'),
  ('P308', 'Peugeot', '308', 'NTNMN96'),
  ('AA8', 'Audi', 'A8', 'DROSSN97'),
  ('OC', 'Opel', 'Corsa', 'DROSSN97'),
  ('OA', 'Opel', 'Astra', 'DROSSN97'),
  ('VG', 'Volkswagen', 'Golf', 'MHLCVR97'),
  ('FF', 'Ford', 'Fiesta', 'MHLCVR97');


INSERT INTO geofence (id, coordinates, max_speed) VALUES 
  ('geo1', ST_Polygon('LINESTRING (15.637847185134886
              41.71252851403209,15.639231204986572
              41.713249319794926,15.637707710266115
              41.714130293639265,15.636173486709595
              41.71451471480548,15.63478946685791
              41.714106267240055,15.635637044906614
              41.71316923066488,15.637847185134886
              41.71252851403209)', 0), 50),

  ('geo2', ST_Polygon('LINESTRING (15.662984848022461
              41.70329347623852, 15.660560131073
              41.704815386419796, 15.656955242156982
              41.70513578397304,15.654079914093018
              41.70335755739365,15.656826496124268
              41.70185163336428,15.663070678710938
              41.70074619859905,15.662984848022461
              41.70329347623852)', 0), 30),

  ('geo3', ST_Polygon('LINESTRING (15.635111331939697
              41.711575436225154, 15.632418394088743
              41.71300905210544, 15.632171630859373
              41.71277679248521,15.631645917892456
              41.71192783638852,15.632482767105103
              41.71058229809793,15.635122060775757
              41.71152738150774,15.635111331939697
              41.711575436225154)', 0), 50);


INSERT INTO geofence_vehicle (license_plate, geofence_id) VALUES
('FP', 'geo3'),
('FP', 'geo1'),
('AA8', 'geo3'),
('P308', 'geo3'),
('OC', 'geo1'),
('OA', 'geo1'),
('FF', 'geo1'),
('VG', 'geo1'),
('VG', 'geo2');

INSERT INTO event (license_plate,geofence_id, timestamp, type) VALUES
('P308','geo3',1657026798332,'Enter'),
('P308','geo3',1657026808124,'Inside'),
('P308','geo3',1657026818674,'Inside'),
('OA','geo1',1656700027789,'Enter'),
('OA','geo1',1656700033184,'Inside'),
('VG','geo2',1656776411870,'Enter'),
('VG','geo2',1656776418532,'Inside'),
('VG','geo2',1656796819562,'Exit'),
('VG','geo1',1656796819563,'Enter'),
('VG','geo1',1656801829120,'Inside');

INSERT INTO position (vehicle_license_plate, timestamp, latitude, longitude, altitude, speed, point ) VALUES
('P308', 1657026798332,41.7111109057853,15.632729530334473, 12, 35, ST_Point(15.632729530334473,41.7111109057853)),
('P308', 1657026808124,41.71192783638852,15.631957054138184, 12, 35, ST_Point(15.631957054138184,41.71192783638852)),
('P308', 1657026818674,41.71269670276638,15.632429122924803, 12, 39, ST_Point(15.632429122924803,41.71269670276638)),
('OA', 1656700027789,41.714138302437014,15.636527538299559, 12, 44, ST_Point(15.636527538299559,41.714138302437014)),
('OA', 1656700033184,41.71405821441464,15.635497570037842, 12, 46, ST_Point(15.635497570037842,41.71405821441464)),
('VG', 1656776411870,41.70217204568591,15.662384033203125, 12, 23, ST_Point(15.662384033203125,41.70217204568591)),
('VG', 1656776418532,41.701803571378335,15.659980773925783, 12, 22, ST_Point(15.659980773925783,41.701803571378335)),
('VG', 1656796819563,41.71405821441464,15.637160539627075, 12, 35, ST_Point(15.637160539627075,41.71405821441464)),
('VG', 1656801829120,41.714154320029515,15.63631296157837, 12, 35, ST_Point(15.63631296157837,41.714154320029515)),
('AA8', 1656767663743,41.70947701343257,15.63330888748169, 12, 83, ST_Point(15.63330888748169,41.70947701343257)),
('AA8', 1656767670213,41.7099255370372,15.63285827636719, 12, 83, ST_Point(15.63285827636719,41.7099255370372)),
('AA8', 1656767676897,41.71002164883105,15.631999969482422, 12, 83, ST_Point(15.631999969482422,41.71002164883105)),
('AA8', 1656767683342,41.710326001896924,15.630970001220703, 12, 83, ST_Point(15.630970001220703,41.710326001896924)),
('OA', 1656904100876,41.70560035758929,15.657963752746582, 12, 83, ST_Point(15.657963752746582,41.70560035758929)),
('OA', 1656904105128,41.7052799623511,15.65925121307373, 12, 83, ST_Point(15.65925121307373,41.7052799623511)),
('OA', 1656904112589,41.706946000154815,15.658349990844727, 12, 83, ST_Point(15.658349990844727,41.706946000154815)),
('OA', 1656904124365,41.708195500175876,15.659422874450684, 12, 83, ST_Point(15.659422874450684,41.708195500175876));
